name: Deployment
on: push

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: echo 'run tests'

  deploy-dev:
    name: Dev deployment
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: echo 'dev deployment'

  deploy-production:
    name: Prod deployment
    needs: deploy-dev
    environment: production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: echo 'production deployment'

  ready-to-go:
    name: Ready to go
    needs: deploy-dev
    runs-on: ubuntu-latest
    steps:
      - run: |
          BODY=$(jq -n --argjson env_id $PROD_ENV_ID \
              '{"environment_ids":[$env_id],"state":"approved","comment":"Ship it!"}')

          curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/pending_deployments \
              -d "$BODY"

        env:
          RUN_ID: ${{ github.run_id }}
          PROD_ENV_ID: 598617706
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
